<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTI-NLP Enhanced Analyzer v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .risk-color-low { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
        }
        
        .risk-color-medium { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.4);
        }
        
        .risk-color-high { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
        }
        
        .tab-active { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .tab-inactive { 
            background: white;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        
        .tab-inactive:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        
        .alert-critical { border-left: 4px solid #dc2626; background: #fef2f2; }
        .alert-high { border-left: 4px solid #f59e0b; background: #fffbeb; }
        .alert-medium { border-left: 4px solid #3b82f6; background: #eff6ff; }
        .alert-low { border-left: 4px solid #10b981; background: #f0fdf4; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in-up { animation: fadeInUp 0.6s ease-out; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse { animation: pulse 2s ease-in-out infinite; }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 fade-in-up">
            <div class="inline-block mb-4">
                <div class="text-7xl">üõ°Ô∏è</div>
            </div>
            <h1 class="text-4xl sm:text-5xl font-black text-white tracking-tight mb-3" style="text-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                CTI Enhanced Threat Analyzer v2.0
            </h1>
            <p class="text-xl text-white opacity-90 font-medium">
                Advanced URL, IP & Device Security Platform
            </p>
        </header>

        <!-- Quick Stats Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 fade-in-up">
            <div class="glass-effect p-6 rounded-xl stat-card">
                <div class="text-3xl mb-2">üîó</div>
                <div class="text-sm text-gray-600 font-semibold">Active Connections</div>
                <div id="statConnections" class="text-3xl font-black text-blue-600">-</div>
            </div>
            <div class="glass-effect p-6 rounded-xl stat-card">
                <div class="text-3xl mb-2">üö®</div>
                <div class="text-sm text-gray-600 font-semibold">Active Alerts</div>
                <div id="statAlerts" class="text-3xl font-black text-red-600">-</div>
            </div>
            <div class="glass-effect p-6 rounded-xl stat-card">
                <div class="text-3xl mb-2">üíæ</div>
                <div class="text-sm text-gray-600 font-semibold">Connected Drives</div>
                <div id="statDrives" class="text-3xl font-black text-purple-600">-</div>
            </div>
            <div class="glass-effect p-6 rounded-xl stat-card">
                <div class="text-3xl mb-2">ü¶†</div>
                <div class="text-sm text-gray-600 font-semibold">Threats Detected</div>
                <div id="statThreats" class="text-3xl font-black text-orange-600">-</div>
            </div>
        </div>

        <!-- Mode Selector Tabs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 fade-in-up" style="animation-delay: 0.1s;">
            <button id="tabUrl" data-mode="url" class="p-5 text-center text-base font-bold rounded-xl transition-all duration-300 tab-active">
                üåê URL Analysis
            </button>
            <button id="tabReport" data-mode="report" class="p-5 text-center text-base font-bold rounded-xl transition-all duration-300 tab-inactive">
                üìä CTI Reports
            </button>
            <button id="tabIp" data-mode="ip" class="p-5 text-center text-base font-bold rounded-xl transition-all duration-300 tab-inactive">
                üîç IP Tracking
            </button>
            <button id="tabDevice" data-mode="device" class="p-5 text-center text-base font-bold rounded-xl transition-all duration-300 tab-inactive">
                üíæ Device Scan
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="glass-effect p-8 rounded-2xl shadow-2xl mb-8 fade-in-up" style="animation-delay: 0.2s;">
            <h2 id="inputTitle" class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                <span class="mr-3 text-3xl">üéØ</span>
                <span id="titleText">Enter URL for Analysis</span>
            </h2>
            
            <!-- URL Input Mode -->
            <div id="urlInputContainer" class="space-y-4">
                <input type="url" id="urlInput" placeholder="Paste link here (e.g., https://suspicious-site.com)"
                       class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-200 text-lg"
                       value="http://login-verify-paypal.com/update/index.php">
            </div>
            
            <!-- CTI Report Input Mode -->
            <div id="reportInputContainer" class="space-y-4 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üìà Sentiment Score (0.0 - 1.0)</label>
                        <input type="number" id="sentimentInput" min="0" max="1" step="0.01" value="0.75"
                               class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-200 text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">‚ö†Ô∏è Severity Level (1 - 5)</label>
                        <input type="number" id="severityInput" min="1" max="5" step="1" value="4"
                               class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-200 text-lg">
                    </div>
                </div>
            </div>

            <!-- IP Tracking Mode -->
            <div id="ipInputContainer" class="space-y-4 hidden">
                <input type="text" id="ipInput" placeholder="Enter IP address (e.g., 8.8.8.8 or leave empty to scan connections)"
                       class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-200 text-lg">
                <div class="flex gap-4">
                    <button id="scanConnectionsBtn" class="btn-primary text-white font-bold py-3 px-6 rounded-xl flex-1">
                        üîç Scan All Connections
                    </button>
                </div>
            </div>

            <!-- Device Scanning Mode -->
            <div id="deviceInputContainer" class="space-y-4 hidden">
                <div id="drivesList" class="space-y-3 mb-4">
                    <p class="text-gray-600">Loading drives...</p>
                </div>
                <input type="text" id="pathInput" placeholder="Or enter custom path to scan"
                       class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all duration-200 text-lg">
            </div>

            <div class="flex justify-center mt-8">
                <button id="analyzeButton"
                        class="btn-primary text-white font-bold py-4 px-12 rounded-xl shadow-lg disabled:opacity-50 flex items-center text-lg">
                    <span class="mr-2">üîç</span> <span id="btnText">Analyze Now</span>
                </button>
            </div>
            
            <div id="loadingIndicator" class="mt-4 text-center text-blue-600 hidden">
                <svg class="animate-spin h-6 w-6 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="font-semibold text-lg">Analyzing Data...</span>
            </div>
        </div>

        <!-- Results Dashboard -->
        <div id="resultsContainer" class="hidden space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in-up">
                <div class="glass-effect p-8 rounded-2xl shadow-2xl flex flex-col justify-center items-center stat-card">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">‚ö° Risk Score</h3>
                    <div id="riskScoreDisplay" class="text-7xl font-black p-6 rounded-full text-white shadow-2xl">0</div>
                    <p id="riskLevelText" class="text-base mt-4 font-bold"></p>
                </div>

                <div class="glass-effect p-8 rounded-2xl shadow-2xl md:col-span-2 stat-card">
                    <h3 class="text-xl font-bold text-gray-700 mb-6">üéØ Detection Results</h3>
                    <div class="space-y-5">
                        <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                            <span class="font-bold w-48 text-gray-600">Status:</span>
                            <span id="detectionStatus" class="font-black text-2xl"></span>
                        </div>
                        <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                            <span class="font-bold w-48 text-gray-600">Classification:</span>
                            <span id="threatType" class="text-2xl font-black text-blue-600"></span>
                        </div>
                        <div class="flex items-center p-4 bg-gray-50 rounded-xl">
                            <span class="font-bold w-48 text-gray-600">Confidence:</span>
                            <span id="confidence" class="text-xl font-bold text-gray-700"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-effect p-8 rounded-2xl shadow-2xl fade-in-up stat-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Threat Analysis</h2>
                <div class="h-96">
                    <canvas id="threatChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Live Alerts Panel -->
        <div class="glass-effect p-8 rounded-2xl shadow-2xl mt-8 fade-in-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <span class="mr-3">üö®</span> Live Alerts
                </h2>
                <button id="refreshAlertsBtn" class="btn-primary text-white font-bold py-2 px-6 rounded-lg text-sm">
                    üîÑ Refresh
                </button>
            </div>
            <div id="alertsList" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-600 text-center py-8">Loading alerts...</p>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="fixed top-8 left-1/2 -translate-x-1/2 p-5 rounded-xl text-white font-bold shadow-2xl transition-all duration-300 opacity-0 hidden z-50 text-lg"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let currentMode = 'url';
        let myChart = null;
        let alertRefreshInterval = null;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadQuickStats();
            loadAlerts();
            toggleMode('url');
            
            // Auto-refresh alerts every 30 seconds
            alertRefreshInterval = setInterval(loadAlerts, 30000);
        });

        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'fixed top-8 left-1/2 -translate-x-1/2 p-5 rounded-xl font-bold shadow-2xl transition-all duration-300 z-50 text-lg';
            
            if (type === 'error') {
                box.classList.add('bg-gradient-to-r', 'from-red-500', 'to-red-600', 'text-white');
            } else if (type === 'warning') {
                box.classList.add('bg-gradient-to-r', 'from-yellow-500', 'to-yellow-600', 'text-gray-900');
            } else {
                box.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'text-white');
            }

            box.classList.remove('opacity-0', 'hidden');
            setTimeout(() => {
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3500);
        }

        async function loadQuickStats() {
            try {
                // Load connections
                const connResp = await fetch(`${API_BASE_URL}/scan_connections`);
                if (connResp.ok) {
                    const data = await connResp.json();
                    document.getElementById('statConnections').textContent = data.total_connections || 0;
                }

                // Load alerts
                const alertResp = await fetch(`${API_BASE_URL}/alert_statistics`);
                if (alertResp.ok) {
                    const data = await connResp.json();
                    document.getElementById('statAlerts').textContent = data.statistics?.unacknowledged || 0;
                }

                // Load drives
                const driveResp = await fetch(`${API_BASE_URL}/get_drives`);
                if (driveResp.ok) {
                    const data = await driveResp.json();
                    document.getElementById('statDrives').textContent = data.drives?.length || 0;
                }

                // Load scanner stats
                const scanResp = await fetch(`${API_BASE_URL}/scanner_statistics`);
                if (scanResp.ok) {
                    const data = await scanResp.json();
                    document.getElementById('statThreats').textContent = data.statistics?.total_threats_detected || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_alerts?limit=10`);
                if (!response.ok) throw new Error('Failed to load alerts');
                
                const data = await response.json();
                const alertsList = document.getElementById('alertsList');
                
                if (!data.alerts || data.alerts.length === 0) {
                    alertsList.innerHTML = '<p class="text-gray-600 text-center py-8">‚úì No alerts - All systems secure</p>';
                    return;
                }

                alertsList.innerHTML = data.alerts.map(alert => {
                    const severityClass = `alert-${alert.severity.toLowerCase()}`;
                    const icon = {
                        'CRITICAL': 'üö®',
                        'HIGH': 'üî¥',
                        'MEDIUM': '‚ö†Ô∏è',
                        'LOW': '‚ÑπÔ∏è'
                    }[alert.severity] || '‚Ä¢';

                    return `
                        <div class="${severityClass} p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-bold text-gray-800">${icon} ${alert.title}</div>
                                    <div class="text-sm text-gray-600 mt-1">${alert.message}</div>
                                    <div class="text-xs text-gray-500 mt-2">${new Date(alert.timestamp).toLocaleString()}</div>
                                </div>
                                <span class="text-xs font-bold px-3 py-1 rounded-full bg-gray-200">${alert.severity}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading alerts:', error);
                document.getElementById('alertsList').innerHTML = '<p class="text-red-600 text-center py-8">Failed to load alerts</p>';
            }
        }

        async function loadDrives() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_drives`);
                if (!response.ok) throw new Error('Failed to load drives');
                
                const data = await response.json();
                const drivesList = document.getElementById('drivesList');
                
                if (!data.drives || data.drives.length === 0) {
                    drivesList.innerHTML = '<p class="text-gray-600">No drives detected</p>';
                    return;
                }

                drivesList.innerHTML = data.drives.map(drive => {
                    const icon = drive.is_removable ? 'üîå' : 'üíæ';
                    return `
                        <div class="p-4 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="font-bold">${icon} ${drive.device} - ${drive.mountpoint}</div>
                                <div class="text-sm text-gray-600">${drive.used_space_gb} GB / ${drive.total_space_gb} GB (${drive.usage_percent}%)</div>
                            </div>
                            <button class="btn-primary text-white font-bold py-2 px-4 rounded-lg text-sm" 
                                    onclick="scanDrive('${drive.mountpoint}')">
                                Scan Drive
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading drives:', error);
            }
        }

        async function scanDrive(drivePath) {
            showMessage(`Scanning drive: ${drivePath}...`, 'warning');
            try {
                const response = await fetch(`${API_BASE_URL}/scan_directory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ directory_path: drivePath, recursive: true })
                });

                if (!response.ok) throw new Error('Scan failed');
                
                const data = await response.json();
                const result = data.scan_result;
                
                if (result.malicious_files > 0) {
                    showMessage(`‚ö†Ô∏è Found ${result.malicious_files} threats!`, 'error');
                } else {
                    showMessage(`‚úì Drive clean! Scanned ${result.scanned_files} files`, 'success');
                }

                loadQuickStats();
                loadAlerts();

            } catch (error) {
                showMessage('Error scanning drive', 'error');
            }
        }

        function toggleMode(newMode) {
            currentMode = newMode;
            
            // Update tabs
            ['tabUrl', 'tabReport', 'tabIp', 'tabDevice'].forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab.dataset.mode === newMode) {
                    tab.classList.add('tab-active');
                    tab.classList.remove('tab-inactive');
                } else {
                    tab.classList.add('tab-inactive');
                    tab.classList.remove('tab-active');
                }
            });

            // Hide all containers
            ['urlInputContainer', 'reportInputContainer', 'ipInputContainer', 'deviceInputContainer'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Show appropriate container and update title
            const titles = {
                'url': 'üéØ Enter URL for Analysis',
                'report': 'üéØ Enter CTI Report Metrics',
                'ip': 'üéØ IP Address Tracking',
                'device': 'üéØ Device & Drive Scanner'
            };

            const buttons = {
                'url': 'Analyze URL',
                'report': 'Analyze Report',
                'ip': 'Track IP',
                'device': 'Scan Device'
            };

            document.getElementById('titleText').textContent = titles[newMode];
            document.getElementById('btnText').textContent = buttons[newMode];
            document.getElementById(`${newMode}InputContainer`).classList.remove('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');

            if (newMode === 'device') {
                loadDrives();
            }
        }

        async function analyze() {
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            document.getElementById('resultsContainer').classList.add('hidden');

            try {
                let apiUrl, requestBody;

                if (currentMode === 'url') {
                    const url = document.getElementById('urlInput').value.trim();
                    if (!url.startsWith('http')) {
                        throw new Error('URL must start with http:// or https://');
                    }
                    apiUrl = `${API_BASE_URL}/analyze_url`;
                    requestBody = { url };

                } else if (currentMode === 'report') {
                    const sentiment = document.getElementById('sentimentInput').value.trim();
                    const severity = document.getElementById('severityInput').value.trim();
                    apiUrl = `${API_BASE_URL}/analyze`;
                    requestBody = { sentiment, severity };

                } else if (currentMode === 'ip') {
                    const ip = document.getElementById('ipInput').value.trim();
                    if (ip) {
                        apiUrl = `${API_BASE_URL}/track_ip`;
                        requestBody = { ip_address: ip };
                    } else {
                        apiUrl = `${API_BASE_URL}/scan_connections`;
                        requestBody = null;
                    }

                } else if (currentMode === 'device') {
                    const path = document.getElementById('pathInput').value.trim();
                    if (!path) {
                        throw new Error('Please enter a path to scan');
                    }
                    apiUrl = `${API_BASE_URL}/scan_directory`;
                    requestBody = { directory_path: path, recursive: true };
                }

                const options = {
                    method: requestBody ? 'POST' : 'GET',
                    headers: requestBody ? { 'Content-Type': 'application/json' } : {}
                };
                if (requestBody) options.body = JSON.stringify(requestBody);

                const response = await fetch(apiUrl, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                displayResults(data);
                showMessage('‚úì Analysis Complete!', 'success');
                
                loadQuickStats();
                loadAlerts();

            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        function displayResults(data) {
            // Handle different response types
            if (data.risk_score !== undefined) {
                updateStandardResults(data);
            } else if (data.connections) {
                updateConnectionResults(data);
            } else if (data.scan_result) {
                updateScanResults(data.scan_result);
            }
        }

        function updateStandardResults(data) {
            const riskLevel = data.risk_score >= 65 ? 'high' : data.risk_score >= 30 ? 'medium' : 'low';
            const riskColors = { low: 'risk-color-low', medium: 'risk-color-medium', high: 'risk-color-high' };
            
            document.getElementById('riskScoreDisplay').textContent = data.risk_score;
            document.getElementById('riskScoreDisplay').className = `text-7xl font-black p-6 rounded-full text-white shadow-2xl ${riskColors[riskLevel]}`;
            document.getElementById('detectionStatus').textContent = data.detection;
            document.getElementById('threatType').textContent = data.classification;
            document.getElementById('confidence').textContent = `${data.confidence_percent}%`;

            if (myChart) myChart.destroy();
            const ctx = document.getElementById('threatChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.threat_categories,
                    datasets: [{
                        label: 'Probability (%)',
                        data: data.threat_probabilities,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function updateConnectionResults(data) {
            showMessage(`Found ${data.total_connections} active connections, ${data.malicious_count} suspicious`, 
                        data.malicious_count > 0 ? 'warning' : 'success');
            
            // Display connection summary in results
            document.getElementById('riskScoreDisplay').textContent = data.malicious_count;
            document.getElementById('riskScoreDisplay').className = `text-7xl font-black p-6 rounded-full text-white shadow-2xl ${data.malicious_count > 0 ? 'risk-color-high' : 'risk-color-low'}`;
            document.getElementById('riskLevelText').textContent = data.malicious_count > 0 ? 'üö® Threats Found' : '‚úì All Clear';
            document.getElementById('detectionStatus').textContent = data.malicious_count > 0 ? 'MALICIOUS' : 'CLEAN';
            document.getElementById('threatType').textContent = `${data.total_connections} Connections`;
            document.getElementById('confidence').textContent = `${data.malicious_count} Suspicious`;
            
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function updateScanResults(result) {
            showMessage(`Scanned ${result.scanned_files} files, found ${result.malicious_files} threats`, 
                        result.malicious_files > 0 ? 'error' : 'success');
            
            document.getElementById('riskScoreDisplay').textContent = result.malicious_files;
            document.getElementById('riskScoreDisplay').className = `text-7xl font-black p-6 rounded-full text-white shadow-2xl ${result.malicious_files > 0 ? 'risk-color-high' : 'risk-color-low'}`;
            document.getElementById('riskLevelText').textContent = result.malicious_files > 0 ? 'üö® Threats Found' : '‚úì Clean';
            document.getElementById('detectionStatus').textContent = result.malicious_files > 0 ? 'MALICIOUS' : 'CLEAN';
            document.getElementById('threatType').textContent = `${result.scanned_files} Files Scanned`;
            document.getElementById('confidence').textContent = `${result.scan_duration_seconds.toFixed(2)}s Duration`;
            
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        async function scanAllConnections() {
            showMessage('Scanning all active connections...', 'warning');
            try {
                const response = await fetch(`${API_BASE_URL}/scan_connections`);
                if (!response.ok) throw new Error('Scan failed');
                
                const data = await response.json();
                updateConnectionResults(data);
                loadAlerts();
                
            } catch (error) {
                showMessage('Error scanning connections', 'error');
            }
        }

        // Event listeners
        document.getElementById('analyzeButton').addEventListener('click', analyze);
        document.getElementById('tabUrl').addEventListener('click', () => toggleMode('url'));
        document.getElementById('tabReport').addEventListener('click', () => toggleMode('report'));
        document.getElementById('tabIp').addEventListener('click', () => toggleMode('ip'));
        document.getElementById('tabDevice').addEventListener('click', () => toggleMode('device'));
        document.getElementById('refreshAlertsBtn').addEventListener('click', loadAlerts);
        document.getElementById('scanConnectionsBtn').addEventListener('click', scanAllConnections);
    </script>
</body>
</html>